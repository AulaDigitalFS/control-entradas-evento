<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Entradas – Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0; font-family:Arial, sans-serif;
  background:#0f172a; color:#e5e7eb;
  display:flex; justify-content:center; align-items:center; height:100vh;
}
.container{
  background:#020617; padding:25px; border-radius:14px;
  width:360px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.6);
}
h2{margin-top:0}
#reader{margin:15px auto}
#resultado{margin-top:15px;font-size:1.2em;font-weight:bold}
.valida{color:#22c55e}
.usada{color:#facc15}
.error{color:#ef4444}
button{
  margin-top:15px; padding:10px 20px; font-size:1em;
  border:none; border-radius:8px; cursor:pointer;
  background:#2563eb; color:white; display:none
}
button:hover{background:#1d4ed8}
</style>
</head>
<body>
<div class="container">
  <h2>Control de Entradas</h2>
  <div id="reader"></div>
  <div id="resultado"></div>
  <button id="reiniciar">Escanear otra vez</button>
</div>

<script>
// ===== CONFIG FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyCf4xLP2mfVGsoSCtjrtgf1FLNFpwtNpoI",
  authDomain: "control-entradas-evento.firebaseapp.com",
  projectId: "control-entradas-evento"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== QR =====
let html5QrCode;
let leyendo = false;

function mostrar(msg, clase){
  const r = document.getElementById("resultado");
  r.className = clase;
  r.innerText = msg;
  document.getElementById("reiniciar").style.display = "inline-block";
}

function detenerScanner(){
  if(html5QrCode && html5QrCode.isScanning){
    html5QrCode.stop();
  }
}

function iniciarScanner(){
  document.getElementById("resultado").innerText="";
  document.getElementById("resultado").className="";
  document.getElementById("reiniciar").style.display="none";
  leyendo = false;

  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

function onScanSuccess(textoQR){
  if(leyendo) return;      // LEE SOLO UNA VEZ
  leyendo = true;
  detenerScanner();        // DETIENE CÁMARA

  // VALIDACIÓN BÁSICA
  if(!textoQR || textoQR.length < 5){
    mostrar("⛔ QR alterado", "error");
    return;
  }

  const ref = db.collection("entradas").doc(textoQR);

  ref.get().then(doc => {
    if(!doc.exists){
      mostrar("⛔ QR inexistente", "error");
      return;
    }

    const data = doc.data();

    // NO SE USA CAMPO id → el ID del documento ES el QR
    if(data.usada === true){
      mostrar("⚠️ Entrada ya utilizada", "usada");
      return;
    }

    // ENTRADA VÁLIDA
    ref.update({
      usada:true,
      horaIngreso: firebase.firestore.FieldValue.serverTimestamp()
    });

    mostrar("✅ Entrada válida", "valida");
  }).catch(()=>{
    mostrar("⛔ Error de lectura", "error");
  });
}

// BOTÓN
reiniciar.onclick = () => iniciarScanner();

// INICIO
iniciarScanner();
</script>
</body>
</html>
