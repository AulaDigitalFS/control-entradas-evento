<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Entradas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Lector QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .nav a {
      display: block;
      margin-top: 10px;
      color: #38bdf8;
      text-decoration: none;
      text-align: center;
    }
    .container {
      background: #020617;
      padding: 25px 30px;
      border-radius: 12px;
      width: 360px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      text-align: center;
    }
    h2 { margin-top: 0; }
    #reader { margin: 15px auto; }
    #resultado {
      margin-top: 15px;
      font-size: 1.2em;
      font-weight: bold;
    }
    .valida { color: #22c55e; }
    .usada { color: #facc15; }
    .bloqueada { color: #ef4444; }
    #reiniciar {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 1em;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
    }
    #reiniciar:hover { background: #1d4ed8; }
  </style>
</head>
<body>

<div class="container">
  <h2>Validaci√≥n de Entradas</h2>
  <div id="reader" style="width:300px;"></div>
  <div id="resultado"></div>
  <button id="reiniciar">Escanear otra vez</button>
</div>
<div class="nav">
    <a href="admin.html"> Regresar Men√∫</a>
  </div>
<script>
/* =========================
   üî• FIREBASE (UNA SOLA VEZ)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCf4xLP2mfVGsoSCtjrtgf1FLNFpwtNpoI",
  authDomain: "control-entradas-evento.firebaseapp.com",
  projectId: "control-entradas-evento",
  storageBucket: "control-entradas-evento.firebasestorage.app",
  messagingSenderId: "490742741430",
  appId: "1:490742741430:web:c3db7037eed6a121346917",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   üì∑ ESC√ÅNER QR
   ========================= */
let scanner = null;
let bloqueado = false;

const resultado = document.getElementById("resultado");
const btnReiniciar = document.getElementById("reiniciar");

function mostrar(mensaje, clase) {
  resultado.className = clase;
  resultado.innerText = mensaje;
  btnReiniciar.style.display = "inline-block";
}

function iniciarScanner() {
  bloqueado = false;
  resultado.innerText = "";
  resultado.className = "";
  btnReiniciar.style.display = "none";

  if (scanner) {
    scanner.clear().catch(() => {});
  }

  scanner = new Html5QrcodeScanner("reader", {
    fps: 10,
    qrbox: 250,
  });

  scanner.render(onScanSuccess);
}

async function onScanSuccess(textoQR) {
  if (bloqueado) return;
  bloqueado = true;

  scanner.clear();

  if (!textoQR || textoQR.trim().length < 3) {
    mostrar("‚õî QR alterado o inv√°lido", "bloqueada");
    return;
  }

  const codigo = textoQR.trim();
  const ref = db.collection("entradas").doc(codigo);

  try {
    const doc = await ref.get();

    if (!doc.exists) {
      mostrar("‚õî QR inexistente", "bloqueada");
      return;
    }

    const data = doc.data();

    if (data.usada === true) {
      mostrar("‚ö†Ô∏è Entrada ya utilizada", "usada");
      return;
    }

    // üëâ SOLO AQU√ç se marca como usada
    await ref.update({
      usada: true,
      horaIngreso: firebase.firestore.FieldValue.serverTimestamp()
    });

    mostrar("‚úÖ Entrada v√°lida", "valida");

  } catch (error) {
    console.error(error);
    mostrar("‚õî Error de validaci√≥n", "bloqueada");
  }
}


btnReiniciar.onclick = iniciarScanner;
iniciarScanner();


/* ==================================================
   ‚ö†Ô∏è GENERADOR DE ENTRADAS (USAR UNA SOLA VEZ)
   üëâ DESCOMENTA, RECARGA, ESPERA, VUELVE A COMENTAR
   ================================================== abajo cerrar antes del ascript */
/*
const TOTAL = 1500;

(async function generarEntradas() {
  console.log("Generando entradas...");
  for (let i = 1; i <= TOTAL; i++) {
    const codigo = `ADEUESO-${String(i).padStart(4, "0")}`;
    await db.collection("entradas").doc(codigo).set({
      id: codigo,
      usada: false,
      creada: firebase.firestore.FieldValue.serverTimestamp()
    });
    if (i % 100 === 0) console.log(i + " creadas");
  }
  alert("‚úÖ Entradas generadas");
})();
*/
</script>

</body>
</html>

